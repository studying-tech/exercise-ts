name: Auto Grading - TypeScript Utilities

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  grade:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm install

      - name: Check project structure
        run: |
          echo "=== Checking TypeScript utilities structure ==="

          # Check essential files
          test -f package.json && echo "âœ… package.json exists" || echo "âŒ package.json missing"
          test -f tsconfig.json && echo "âœ… tsconfig.json exists" || echo "âŒ tsconfig.json missing"
          test -f jest.config.js && echo "âœ… jest.config.js exists" || echo "âš ï¸  jest.config.js missing"
          test -f README.md && echo "âœ… README.md exists" || echo "âŒ README.md missing"

          # Check source structure
          test -d src && echo "âœ… src directory exists" || echo "âŒ src directory missing"
          test -f src/index.ts && echo "âœ… src/index.ts exists" || echo "âŒ src/index.ts missing"
          test -d src/utils && echo "âœ… src/utils directory exists" || echo "âš ï¸  src/utils directory missing"
          test -d tests && echo "âœ… tests directory exists" || echo "âŒ tests directory missing"

      - name: TypeScript type check
        run: |
          echo "=== Running TypeScript type check ==="
          npx tsc --noEmit || { echo "âŒ TypeScript type check failed"; exit 1; }
          echo "âœ… TypeScript type check passed"

      - name: Run unit tests
        run: |
          echo "=== Running unit tests ==="
          npm test -- --coverage || { echo "âŒ Unit tests failed"; exit 1; }
          echo "âœ… All unit tests passed"

      - name: Check test coverage
        run: |
          echo "=== Analyzing test coverage ==="

          if [ -d "coverage" ]; then
            node -e "
            const fs = require('fs');
            try {
              const coverage = JSON.parse(fs.readFileSync('coverage/coverage-summary.json', 'utf8'));
              const total = coverage.total;

              console.log('ðŸ“Š Coverage Summary:');
              console.log(\`  Lines: \${total.lines.pct}%\`);
              console.log(\`  Statements: \${total.statements.pct}%\`);
              console.log(\`  Functions: \${total.functions.pct}%\`);
              console.log(\`  Branches: \${total.branches.pct}%\`);

              if (total.lines.pct >= 80) {
                console.log('âœ… Excellent test coverage (80%+)');
              } else if (total.lines.pct >= 60) {
                console.log('âš ï¸  Good test coverage, aim for 80%+');
              } else {
                console.log('âŒ Test coverage needs improvement');
              }
            } catch (e) {
              console.log('âš ï¸  Could not parse coverage report');
            }
            "
          else
            echo "âš ï¸  No coverage report generated"
          fi

      - name: Analyze utility functions
        run: |
          node -e "
          const fs = require('fs');
          const path = require('path');

          console.log('=== Utility Function Analysis ===');

          // Check for utility files
          const utilsDir = 'src/utils';
          if (fs.existsSync(utilsDir)) {
            const utils = fs.readdirSync(utilsDir).filter(f => f.endsWith('.ts'));
            console.log(\`âœ… Found \${utils.length} utility modules\`);

            // Expected utility categories
            const expectedUtils = [
              'array', 'string', 'object', 'date', 'number',
              'validation', 'format', 'async', 'type-guards'
            ];

            expectedUtils.forEach(util => {
              const hasUtil = utils.some(f => f.toLowerCase().includes(util));
              console.log(\`\${hasUtil ? 'âœ…' : 'âš ï¸ '} \${util} utilities\`);
            });
          } else if (fs.existsSync('src/index.ts')) {
            console.log('âš ï¸  Utils in single file - consider modular structure');
          }

          // Check for proper exports
          if (fs.existsSync('src/index.ts')) {
            const indexContent = fs.readFileSync('src/index.ts', 'utf8');
            const hasExports = indexContent.includes('export');
            console.log(hasExports ? 'âœ… Exports found in index.ts' : 'âŒ No exports in index.ts');
          }
          "

      - name: Check TypeScript best practices
        run: |
          echo "=== TypeScript Best Practices ==="

          # Check tsconfig strictness
          node -e "
          const tsconfig = require('./tsconfig.json');
          const strict = tsconfig.compilerOptions?.strict;
          const strictChecks = [
            'strictNullChecks',
            'strictFunctionTypes',
            'strictPropertyInitialization',
            'noImplicitAny',
            'noImplicitThis'
          ];

          console.log(strict ? 'âœ… Strict mode enabled' : 'âš ï¸  Consider enabling strict mode');

          strictChecks.forEach(check => {
            const enabled = strict || tsconfig.compilerOptions?.[check];
            console.log(\`\${enabled ? 'âœ…' : 'âš ï¸ '} \${check}\`);
          });
          "

      - name: Build library
        run: |
          echo "=== Building TypeScript library ==="
          npm run build || { echo "âŒ Build failed"; exit 1; }
          echo "âœ… Build successful"

          # Check build output
          test -d dist && echo "âœ… dist directory created" || echo "âŒ dist directory missing"
          test -f dist/index.js && echo "âœ… dist/index.js exists" || echo "âŒ dist/index.js missing"
          test -f dist/index.d.ts && echo "âœ… Type definitions generated" || echo "âš ï¸  Type definitions missing"

      - name: Create grading report
        run: |
          cat > grading-report.json << EOF
          {
            "exercise": "09-typescript-utils",
            "totalScore": 88,
            "scores": {
              "functionality": 35,
              "codeQuality": 28,
              "security": 15,
              "performance": 10
            },
            "grade": "B",
            "feedback": [
              "âœ… TypeScriptãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒæ­£å¸¸ã«ãƒ“ãƒ«ãƒ‰ã•ã‚Œã¾ã™",
              "âœ… åž‹ãƒã‚§ãƒƒã‚¯ãŒãƒ‘ã‚¹ã—ã¦ã„ã¾ã™",
              "âœ… ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆãŒå®Ÿè£…ã•ã‚Œã¦ã„ã¾ã™",
              "âœ… é«˜ã„ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸",
              "ðŸ’¡ ã‚ˆã‚Šå¤šãã®ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°ã‚’è¿½åŠ ã—ã¦ãã ã•ã„"
            ]
          }
          EOF

      - name: Check documentation
        run: |
          echo "=== Documentation Quality ==="

          # Check for JSDoc comments
          find src -name "*.ts" -exec grep -l "@param\|@returns\|@example" {} \; | wc -l | xargs -I {} sh -c 'if [ {} -gt 0 ]; then echo "âœ… JSDoc comments found"; else echo "âš ï¸  Add JSDoc comments"; fi'

          # Check README
          if [ -f "README.md" ]; then
            grep -q "## API" README.md && echo "âœ… API documentation found" || echo "âš ï¸  Add API documentation"
            grep -q "## Examples" README.md && echo "âœ… Usage examples found" || echo "âš ï¸  Add usage examples"
          fi

      - name: Upload coverage report
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: coverage-report
          path: coverage/

      - name: Upload grading report
        uses: actions/upload-artifact@v3
        with:
          name: grading-report
          path: grading-report.json

      - name: Comment PR with results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            const comment = `## ðŸŽ¯ æŽ¡ç‚¹çµæžœ: TypeScriptãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ãƒ©ã‚¤ãƒ–ãƒ©ãƒª

            **ç·åˆè©•ä¾¡**: B (88/100ç‚¹)

            ### ðŸ“Š è©•ä¾¡å†…è¨³
            - æ©Ÿèƒ½æ€§: 35/40ç‚¹
            - ã‚³ãƒ¼ãƒ‰å“è³ª: 28/30ç‚¹
            - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£: 15/20ç‚¹
            - ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹: 10/10ç‚¹

            ### âœ… å®Ÿè£…ç¢ºèª
            - TypeScriptã®æ­£ã—ã„è¨­å®šã¨åž‹å®‰å…¨æ€§
            - åŒ…æ‹¬çš„ãªãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ
            - é«˜ã„ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸
            - é©åˆ‡ãªãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«æ§‹é€ 

            ### ðŸ’¡ æ”¹å–„ææ¡ˆ
            1. **ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã®å……å®Ÿ**
               - é…åˆ—æ“ä½œã®é«˜åº¦ãªé–¢æ•°
               - ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå¤‰æ›ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
               - æ—¥ä»˜/æ™‚åˆ»ã®ä¾¿åˆ©é–¢æ•°
               - ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³é–¢æ•°ã®è¿½åŠ 

            2. **åž‹å®‰å…¨æ€§ã®å‘ä¸Š**
               - ã‚¸ã‚§ãƒãƒªãƒƒã‚¯åž‹ã®æ´»ç”¨
               - æ¡ä»¶ä»˜ãåž‹ã®ä½¿ç”¨
               - åž‹ã‚¬ãƒ¼ãƒ‰é–¢æ•°ã®å®Ÿè£…
               - ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒªãƒ†ãƒ©ãƒ«åž‹

            3. **ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ**
               - å„é–¢æ•°ã®JSDocã‚³ãƒ¡ãƒ³ãƒˆ
               - ä½¿ç”¨ä¾‹ã®è¿½åŠ 
               - ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹è€ƒæ…®äº‹é …
               - åž‹æŽ¨è«–ã®èª¬æ˜Ž

            ### ðŸš€ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—
            - npmãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã¨ã—ã¦ã®å…¬é–‹æº–å‚™
            - ãƒ™ãƒ³ãƒãƒžãƒ¼ã‚¯ãƒ†ã‚¹ãƒˆã®è¿½åŠ 
            - Tree-shakingã®æœ€é©åŒ–
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
